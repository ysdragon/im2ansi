name: Build

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
    paths-ignore:
      - '**/*.md'


permissions:
  contents: write

jobs:
  build-linux:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            deb_arch: amd64
            rpm_arch: x86_64
            artifact_suffix: amd64
          - os: ubuntu-24.04-arm
            deb_arch: arm64
            rpm_arch: aarch64
            artifact_suffix: arm64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Ring
        uses: ysdragon/ring-action@v1.3.3
        with:
          file: im2ansi.ring
          ring_packages: ringstbimage ringfastpro
          args: -dist -stbimage -fastpro
          output_exe: "true"

      - name: Prepare artifact
        run: sudo chmod +x target/linux/dist_using_scripts/bin/im2ansi

      - name: Build .deb package
        run: |
          mkdir -p deb-pkg/DEBIAN
          mkdir -p deb-pkg/usr/bin
          mkdir -p deb-pkg/usr/lib
          cp target/linux/dist_using_scripts/bin/im2ansi deb-pkg/usr/bin/
          cp -r target/linux/dist_using_scripts/lib/* deb-pkg/usr/lib/
          cat > deb-pkg/DEBIAN/control << 'EOF'
          Package: im2ansi
          Version: ${GITHUB_REF_NAME#v}
          Section: graphics
          Priority: optional
          Architecture: ${{ matrix.deb_arch }}
          Maintainer: ysdragon
          Description: Convert images to ANSI art
          EOF
          sed -i "s/\${GITHUB_REF_NAME#v}/$(echo ${GITHUB_REF_NAME} | sed 's/^v//' | grep -E '^[0-9]' || echo '1.0.7')/" deb-pkg/DEBIAN/control
          dpkg-deb --build deb-pkg im2ansi-linux-${{ matrix.deb_arch }}.deb

      - name: Build .rpm package
        run: |
          sudo apt-get update && sudo apt-get install -y rpm
          mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p rpmbuild/BUILDROOT/im2ansi-1.0.7-1.${{ matrix.rpm_arch }}/usr/bin
          mkdir -p rpmbuild/BUILDROOT/im2ansi-1.0.7-1.${{ matrix.rpm_arch }}/usr/lib
          cp target/linux/dist_using_scripts/bin/im2ansi rpmbuild/BUILDROOT/im2ansi-1.0.7-1.${{ matrix.rpm_arch }}/usr/bin/
          cp -r target/linux/dist_using_scripts/lib/* rpmbuild/BUILDROOT/im2ansi-1.0.7-1.${{ matrix.rpm_arch }}/usr/lib/
          cat > rpmbuild/SPECS/im2ansi.spec << 'EOF'
          Name: im2ansi
          Version: 1.0.7
          Release: 1
          Summary: Convert images to ANSI art
          License: MIT
          BuildArch: ${{ matrix.rpm_arch }}
          
          %description
          Convert images to ANSI art
          
          %files
          /usr/bin/im2ansi
          EOF
          for f in target/linux/dist_using_scripts/lib/*; do
            echo "/usr/lib/$(basename "$f")" >> rpmbuild/SPECS/im2ansi.spec
          done
          rpmbuild --define "_topdir $(pwd)/rpmbuild" -bb rpmbuild/SPECS/im2ansi.spec
          cp rpmbuild/RPMS/${{ matrix.rpm_arch }}/*.rpm im2ansi-linux-${{ matrix.rpm_arch }}.rpm

      - name: Create archives
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cd target/linux/dist_using_scripts
          zip -r ../../../im2ansi-linux-${{ matrix.artifact_suffix }}.zip bin lib
          tar -czvf ../../../im2ansi-linux-${{ matrix.artifact_suffix }}.tar.gz bin lib

      - name: Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            im2ansi-linux-${{ matrix.artifact_suffix }}.zip
            im2ansi-linux-${{ matrix.artifact_suffix }}.tar.gz
            im2ansi-linux-${{ matrix.deb_arch }}.deb
            im2ansi-linux-${{ matrix.rpm_arch }}.rpm

  build-macos:
    strategy:
      matrix:
        include:
          - os: macos-15
            arch: arm64
          - os: macos-15-intel
            arch: x86_64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Ring
        uses: ysdragon/ring-action@v1.3.3
        with:
          file: im2ansi.ring
          ring_packages: ringstbimage ringfastpro
          args: -dist -stbimage -fastpro
          output_exe: "true"
          cache: ${{ matrix.os != 'macos-15-intel' }}

      - name: Prepare artifact
        run: chmod +x target/macosx/bin/im2ansi

      - name: Create DMG
        run: hdiutil create -volname "im2ansi" -srcfolder target/macosx -ov -format UDZO im2ansi-macos-${{ matrix.arch }}.dmg

      - name: Create archives
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cd target/macosx
          zip -r ../../im2ansi-macos-${{ matrix.arch }}.zip bin lib
          tar -czvf ../../im2ansi-macos-${{ matrix.arch }}.tar.gz bin lib

      - name: Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            im2ansi-macos-${{ matrix.arch }}.zip
            im2ansi-macos-${{ matrix.arch }}.tar.gz
            im2ansi-macos-${{ matrix.arch }}.dmg

  build-windows:
    strategy:
      matrix:
        include:
          - arch: x64
            artifact_suffix: x64
          - arch: x86
            artifact_suffix: x86
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Ring
        uses: ysdragon/ring-action@v1.3.3
        with:
          file: im2ansi.ring
          ring_packages: ringstbimage ringfastpro
          args: -dist -stbimage -fastpro
          output_exe: "true"
          arch: ${{ matrix.arch }}

      - name: Create Zip archive
        if: startsWith(github.ref, 'refs/tags/')
        run: Compress-Archive -Path target/windows/* -DestinationPath im2ansi-windows-${{ matrix.artifact_suffix }}.zip

      - name: Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: im2ansi-windows-${{ matrix.artifact_suffix }}.zip